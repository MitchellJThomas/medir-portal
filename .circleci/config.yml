---
version: 2
jobs:

  UI-Build:
    docker:
      - image: circleci/node:latest
    steps:
      - checkout
      - run:
          name: Node Version
          command: |
            node -v
      - run:
          name: Yarn it
          command: |
            cd ui/medir-ui
            yarn install
            yarn build
      - persist_to_workspace:
          root: build
          paths:
            - /*

  Webserver-Build:
    docker:
      - image: circleci/node:latest
    steps:
      - checkout
      - setup_remote_docker
      - attach_workspace:
          at: build
      - run:
          name: Remote build of webserver
          working_directory:  web-portal
          command: |
            TAG=0.2.$CIRCLE_BUILD_NUM
            docker login -u $DOCKER_USER -p $DOCKER_PASS
            echo "Building medir-portal:$TAG"
            docker build -t mitchelljthomas/medir-portal:$TAG .
            docker push mitchelljthomas/medir-portal:$TAG


workflows:
  version: 2
  Medir_Portal:
    jobs:
      - UI-Build
      - Webserver-Build:
          requires:
            - UI-Build
